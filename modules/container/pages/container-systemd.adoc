= manage a container with systemd
Nick Hardiman 
:source-highlighter: highlight.js
:revdate: 30-01-2021

Control your container with systemd.


Add systemd config for your new container.
The container must already exist. 
This procedure uses a container called `mojoservice`, owned by _root_.  

The mojoservice container is stopped. 

[source,shell]
----
[nick@guest1 ~]$ sudo podman ps -a
[sudo] password for nick: 
CONTAINER ID  IMAGE                    COMMAND               CREATED         STATUS                         PORTS                   NAMES
635ee754fd2f  localhost/myperl:latest  /usr/local/bin/mo...  17 minutes ago  Exited (0) About a minute ago  0.0.0.0:3000->3000/tcp  mojoservice
[nick@guest1 ~]$ 
----


== create a systemd unit

Carry out these commands as root. 
This procedure adds a file to /etc/systemd/system/, and only root can write to that directory. 

[source,shell]
----
[nick@guest1 ~]$ sudo su -
[sudo] password for nick: 
Last login: Thu Aug  6 12:39:14 EDT 2020 on pts/0
[root@guest1 ~]# 
----


== view the systemd unit configuration

Display the systemd configuration for our new container. 
It doesn't matter if the container is running or stopped.

Podman generates a suggested unit file name and adds it to the comments. 
It's a very long name: _container-635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab23463826e2de5.service_.
This name uses the full container ID, a huge SHA256 message digest 
(the command `podman ps` only shows the first 12 characters). 


[source,shell]
----
[root@guest1 ~]# podman generate systemd mojoservice
# container-635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab23463826e2de5.service
# autogenerated by Podman 1.9.3
# Sat Aug  8 09:43:27 EDT 2020

[Unit]
Description=Podman container-635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab23463826e2de5.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
ExecStart=/usr/bin/podman start 635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab23463826e2de5
ExecStop=/usr/bin/podman stop -t 10 635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab23463826e2de5
PIDFile=/var/run/containers/storage/overlay-containers/635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab23463826e2de5/userdata/conmon.pid
KillMode=none
Type=forking

[Install]
WantedBy=multi-user.target default.target
[root@guest1 ~]# 
----

== pick a meaningful file name  

Decide what to call the new service unit file. 

[source,shell]
----
[root@guest1 ~]# UNIT=mojo.service
[root@guest1 ~]# 
----

== create the unit file

Put the config where systemd will read it. 
Systemd doesn't monitor its config files for changes. 
Tell systemd to re-read the config. 
Check the status of our new unit.

[source,shell]
----
[root@guest1 ~]# podman generate systemd mojoservice > /etc/systemd/system/$UNIT
[root@guest1 ~]# 
[root@guest1 ~]# systemctl daemon-reload 
[root@guest1 ~]# 
[root@guest1 ~]# systemctl status $UNIT
● mojo.service - Podman container-635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab23463826e2de5.service
   Loaded: loaded (/etc/systemd/system/mojo.service; disabled; vendor preset: disabled)
   Active: inactive (dead)
     Docs: man:podman-generate-systemd(1)
[root@guest1 ~]# 
----

Does it work?
Start the service and check. 

[source,shell]
----
[root@guest1 ~]# systemctl start $UNIT
[root@guest1 ~]# 
[root@guest1 ~]# systemctl status $UNIT
● mojo.service - Podman container-635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab23463826e2de5.service
   Loaded: loaded (/etc/systemd/system/mojo.service; disabled; vendor preset: disabled)
   Active: active (running) since Sat 2020-08-08 09:58:21 EDT; 4s ago
     Docs: man:podman-generate-systemd(1)
  Process: 2115 ExecStart=/usr/bin/podman start 635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab23463826e2de5 (code=exited, stat>
 Main PID: 2208 (conmon)
    Tasks: 2 (limit: 8103)
   Memory: 1.6M
   CGroup: /system.slice/mojo.service
           └─2208 /usr/bin/conmon --api-version 1 -s -c 635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab23463826e2de5 -u 635ee75>

Aug 08 09:58:20 guest3.lab.example.com systemd[1]: Starting Podman container-635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab234>
Aug 08 09:58:21 guest3.lab.example.com podman[2115]: 635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab23463826e2de5
Aug 08 09:58:21 guest3.lab.example.com systemd[1]: Started Podman container-635ee754fd2ff25990ae1cd77ed4e89cccdb4eeb5b5aad75eab2346>
[root@guest1 ~]# 
[root@guest1 ~]# curl http://localhost:3000
I ♥ Mojolicious![root@guest1 ~]# 
----

Make the container start when the system starts. 

The systemd config line `WantedBy=multi-user.target default.target` tells systemd to create two symlinks. 

[source,shell]
----
[root@guest1 ~]# systemctl enable $UNIT
Created symlink /etc/systemd/system/multi-user.target.wants/mojo.service → /etc/systemd/system/mojo.service.
Created symlink /etc/systemd/system/default.target.wants/mojo.service → /etc/systemd/system/mojo.service.
[root@guest1 ~]# 
----


Try a final test. Does the container still respond after a reboot?

[source,shell]
----
[root@guest1 ~]# systemctl reboot
Connection to guest3 closed by remote host.
Connection to guest3 closed.
[nick@host1 ~]$ 
[nick@host1 ~]$ ssh nick@guest1.lab.example.com
Activate the web console with: systemctl enable --now cockpit.socket

This system is not registered to Red Hat Insights. See https://cloud.redhat.com/
To register this system, run: insights-client --register

Last login: Sat Aug  8 09:19:54 2020 from 192.168.122.1
[nick@guest1 ~]$ 
[nick@guest1 ~]$ curl http://localhost:3000
I ♥ Mojolicious![nick@guest1 ~]$ 
----

== other things 

Use cgroups to control this container's use of resources. 
